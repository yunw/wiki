<html>
<head>
<link rel="Stylesheet" type="text/css" href="style.css" />
<title>mksdcard-hs13.sh</title>
<meta http-equiv="Content-Type" content="text/html; charset=" />
</head>
<body>
<p>
#!/bin/sh
</p>

<ol>
<li>
set verbose to "1" to print 
</li>
</ol>
<p>
VERBOSE=0
</p>

<ol>
<li>
================================================================== #
</li>
<li>
    Configure if the SW images are kept in different directories
</li>
<li>
================================================================== #
</li>
<li>
no padding uboot
</li>
</ol>
<p>
UBOOT=./u-boot.bin  # modify to tell where is the no padding uboot
</p>

<ol>
<li>
kernel
</li>
</ol>
<p>
KERNEL=./uImage # modify to tell where is kernel
</p>

<ol>
<li>
ramdisk
</li>
</ol>
<p>
RAMDISKIMG=./uramdisk.img # modify to tell where is ramdisk
</p>

<ol>
<li>
android rootfs
</li>
</ol>
<p>
ROOTFSIMG=./system.img # modify to tell where is android rootfs
</p>

<ol>
<li>
recovery image
</li>
</ol>
<p>
RECOVERYIMG=./recovery.img # modify to tell where is recovery image
</p>

<ol>
<li>
vfat mininal partition size
</li>
</ol>
<p>
MIN_VFAT_SIZE=50 # modify to set the small partition size for the 1st partition format mounted as SD card to Android
</p>

<ol>
<li>
================================================================== #
</li>
</ol>
<p>
help() {
</p>

<p>
local BN=<code>basename $0</code>
cat &lt;&lt; EOF
usage $BN &lt;option&gt; device_node
</p>

<p>
options:
  -h				displays this help message
  -s				only get partition size
EOF
</p>

<p>
}
</p>
<ol>
<li>
================================================================== #
</li>
</ol>
<p>
check_if_root() {
</p>
<ol>
<li>
check the if root?
</li>
</ol>
<p>
USERID=<code>id -u</code>
if [ ${USERID} -ne "0" ]; then
	echo "you're not root?"
	exit 1
fi
}
</p>
<ol>
<li>
================================================================== #
</li>
</ol>
<p>
get_imagesizes() {
</p>
<ol>
<li>
partition size in MB
</li>
</ol>
<p>
BOOT_ROM_SIZE=8
</p>

<p>
SYSTEM_ROM_SIZE=$(wc -c ${ROOTFSIMG}|cut -d' ' -f1)
SYSTEM_ROM_SIZE=$(( ${SYSTEM_ROM_SIZE} / 1024 / 1024 + 2 ))
</p>

<p>
DATA_SIZE=$(( ${SYSTEM_ROM_SIZE} * 2 ))
</p>

<p>
CACHE_SIZE=$(( ${SYSTEM_ROM_SIZE} ))
</p>

<p>
RECOVERY_ROM_SIZE=$(wc -c ${RECOVERYIMG}|cut -d' ' -f1)
RECOVERY_ROM_SIZE=$(( ${RECOVERY_ROM_SIZE} / 1024 / 1024 + 2 ))
</p>
	
<p>
if [ "${VERBOSE}" -eq "1" ];then
cat &lt;&lt; EOF
SYSTEM : ${SYSTEM_ROM_SIZE}MB
RECO   : ${RECOVERY_ROM_SIZE}MB
DATA   : ${DATA_SIZE}MB
CACHE  : ${CACHE_SIZE}MB
EOF
fi
</p>

<p>
}
</p>
<ol>
<li>
================================================================== #
</li>
</ol>
<p>
umount_partitions () {
</p>
<blockquote>
local PARTITIONS=<code>mount | grep -c ${NODE}</code>
if [ "${PARTITIONS}" -gt 0 ];then
echo "umount partitions of ${NODE}..."
umount <code>mount | grep  ${NODE} | awk '{printf("%s* ",$3)}'</code>
sleep 2
else
echo "${NODE} does not have partitions mounted..."
fi
</blockquote>
<p>
}
</p>
<ol>
<li>
================================================================== #
</li>
</ol>
<p>
cal_partitions_size () {
</p>

<ol>
<li>
call sfdisk to create partition table
</li>
<li>
get total card size
</li>
</ol>
<p>
TOTAL_SIZE=<code>sfdisk -s ${NODE}</code>
TOTAL_SIZE=<code>expr ${TOTAL_SIZE} / 1024</code>
local ROM_SIZE=<code>expr ${BOOT_ROM_SIZE} + ${SYSTEM_ROM_SIZE} + ${DATA_SIZE}</code>
ROM_SIZE=<code>expr ${ROM_SIZE} + ${CACHE_SIZE} + ${RECOVERY_ROM_SIZE}</code>
BVFAT_SIZE=<code>expr ${TOTAL_SIZE} - ${ROM_SIZE} - 20 </code>
VFAT_SIZE=<code>expr ${TOTAL_SIZE} - ${ROM_SIZE} - 20 - 20 </code>
EXTEND_SIZE=<code>expr ${DATA_SIZE} + ${CACHE_SIZE} + 8</code>
</p>

<p>
if [ "${VFAT_SIZE}" -lt "${MIN_VFAT_SIZE}" ];then 
	echo "ERROR: Use large size SD card ............."
</p>
<blockquote>
print_sdcard_partition
exit 1
</blockquote>
<p>
fi
</p>
 
<p>
if [ "${VERBOSE}" -eq "1" ];then
cat &lt;&lt; EOF
TOTAL_SIZE : ${TOTAL_SIZE}MB
ROM_SIZE   : ${ROM_SIZE}MB
BVFAT_SIZE : ${BVFAT_SIZE}MB
VFAT_SIZE  : ${VFAT_SIZE}MB
EXTEND_SIZE: ${EXTEND_SIZE}MB
EOF
fi
</p>

<p>
}
</p>
<ol>
<li>
================================================================== #
</li>
</ol>
<p>
print_sdcard_partition() {
cat &lt;&lt; EOF
TOTAL_SIZE          : ${TOTAL_SIZE}MB
   ROM_SIZE         : ${BOOT_ROM_SIZE}MB
[1]VFAT_SIZE        : ${VFAT_SIZE}MB
[2]SYSTEM_ROM_SIZE  : ${SYSTEM_ROM_SIZE}MB
[3]EXTEND_SIZE      : ${EXTEND_SIZE}MB
[4]RECOVERY_ROM_SIZE: ${RECOVERY_ROM_SIZE}MB
[5]DATA_SIZE        : ${DATA_SIZE}MB
[6]CACHE_SIZE       : ${CACHE_SIZE}MB
EOF
}
</p>
<ol>
<li>
================================================================== #
</li>
</ol>
<p>
sfdisk_sdcard() {
</p>
<ol>
<li>
destroy the partition table
</li>
</ol>
<p>
dd if=/dev/zero of=${NODE} bs=1024 count=1
</p>

<p>
umount_partitions
</p>

<p>
sfdisk --force -uM ${NODE} &lt;&lt; EOF
,${BVFAT_SIZE},b
,${SYSTEM_ROM_SIZE},83
,${EXTEND_SIZE},5
,${RECOVERY_ROM_SIZE},83
,${DATA_SIZE},83
,${CACHE_SIZE},83
EOF
</p>

<p>
umount_partitions
</p>

<p>
sfdisk --force -uM ${NODE} -N1 &lt;&lt; EOF
${BOOT_ROM_SIZE},${VFAT_SIZE},b
EOF
</p>

<p>
}
</p>

<p>
format_sdcard() {
</p>
<ol>
<li>
format the SDCARD/DATA/CACHE partition
</li>
</ol>
<p>
PART=""
echo ${NODE} | grep mmcblk &gt; /dev/null
if [ "$?" -eq "0" ]; then
	PART="p"
fi
</p>

<p>
umount_partitions
</p>

<p>
mkfs.vfat ${NODE}${PART}1
echo "format fat partition"
mkfs.ext4 ${NODE}${PART}2 -O ^extent -L system
mkfs.ext4 ${NODE}${PART}4 -O ^extent -L recovery
mkfs.ext4 ${NODE}${PART}5 -O ^extent -L data
mkfs.ext4 ${NODE}${PART}6 -O ^extent -L cache
</p>

<p>
}
</p>
<ol>
<li>
================================================================== #
</li>
</ol>
<p>
program_sdcard() {
echo "copy uboot..."
dd if=${UBOOT} of=${NODE} bs=1K skip=1 seek=1 &amp;&amp; sync &amp;&amp; sync
echo "copy linux kernel..."
dd if=${KERNEL} of=${NODE} bs=1M seek=1 &amp;&amp; sync &amp;&amp; sync
echo "copy rootfs image..."
dd if=${RAMDISKIMG} of=${NODE} bs=6M seek=1 &amp;&amp; sync &amp;&amp; sync
echo "copy system image..."
dd if=${ROOTFSIMG} of=${NODE}${PART}2  &amp;&amp; sync &amp;&amp; sync
echo "copy recovery image..."
dd if=${RECOVERYIMG} of=${NODE}${PART}4  &amp;&amp; sync &amp;&amp; sync
}
</p>
<ol>
<li>
================================================================== #
</li>
<li>
   MAIN
</li>
<li>
================================================================== #
</li>
</ol>

<p>
check_if_root
</p>

<p>
MOREOPTIONS=1
NODE="na"
CAL_ONLY=0
</p>

<p>
while [ "$MOREOPTIONS" = 1 -a $# -gt 0 ]; do
	case $1 in
		-h) help; exit ;;
		-s) CAL_ONLY=1 ;;
		*)  MOREOPTIONS=0; NODE=$1 ;;
	esac
	[ "$MOREOPTIONS" = 0 ] &amp;&amp; [ $# -gt 1 ] &amp;&amp; help &amp;&amp; exit
	[ "$MOREOPTIONS" = 1 ] &amp;&amp; shift
done
</p>

<p>
if [ ! -e ${NODE} ]; then
	help
	exit
fi
</p>

<p>
get_imagesizes
</p>

<p>
cal_partitions_size
</p>

<p>
if [ "${CAL_ONLY}" -eq "1" ]; then
	print_sdcard_partition
	exit 0
fi
</p>

<p>
sfdisk_sdcard
</p>

<p>
format_sdcard
</p>

<p>
program_sdcard
</p>

<p>
exit 0
</p>

</body>
</html>
